import { useEffect, useRef, useState } from 'react';
import Background from '../assets/images/background.jpg';
import { Link, useNavigate } from 'react-router-dom';
import useLoadingBar from '../hooks/useLoading';
import useAuth from '../hooks/useAuth';
import useToast from '../hooks/useToast';
import { FaRegEyeSlash, FaRegEye } from 'react-icons/fa';
import { ToastTypes } from '../context/ToastProvider';

export default function Login() {
  const navigate = useNavigate();
  const { setLoading } = useLoadingBar();
  const { login } = useAuth();
  const { showToast } = useToast();

  console.log(setLoading); // Ìï®ÏàòÍ∞Ä Ï∂úÎ†•ÎêòÎäîÏßÄ ÌôïÏù∏

  const idRef = useRef();
  const passRef = useRef();
  const btnLoginRef = useRef();

  const initialRequest = {
    admin_id: '',
    password: '',
  };

  const [request, setRequest] = useState(initialRequest);
  const [showPass, setShowPass] = useState(false);
  const [authMethod, setAuthMethod] = useState('FIDO'); // FIDOÍ∞Ä Í∏∞Î≥∏ ÏÑ†ÌÉù
  const [otpCode, setOtpCode] = useState(''); // OTP Î≤àÌò∏ ÏÉÅÌÉú

  useEffect(() => {
    idRef.current.focus();
  }, []);

  const handleSubmit = async (e) => {
    // e.preventDefault();

    console.log('hello');
    setLoading(true);

    try {
      //Call api auth endpoint
      setLoading(true);
      console.log('[Authentication request] ', request);
      await authenticate(request).then((response) => {
        console.log(
          'üöÄ ~ file: Login.jsx:63 ~ handleSubmit ~ response:',
          response,
        );
        if (response && response.data && response.data.resultCode === 200) {
          if (response.data.detail && isString(response.data.detail)) {
            const token = response.data.detail;
            const decodedToken = jwtDecode(token);
            console.log('üöÄ ~ awaitauthenticate ~ decodedToken:', decodedToken);
            Cookies.set('access-token', token, { expires: 1 });
            const adminInfo = {
              admin_seq: decodedToken.sub ?? '',
              admin_id: decodedToken.admin_id,
              admin_level_cd: decodedToken.admin_level_cd,
              admin_level_nm: decodedToken.admin_level_nm,
              admin_name: decodedToken.admin_name,
              admin_type: decodedToken.admin_type,
            };
            axiosInstance.interceptors.request.use(
              (config) => {
                config.headers['Authorization'] = `Bearer ${token}`;
                return config;
              },
              (error) => {
                return Promise.reject(error);
              },
            );
            setLoading(false);

            login(adminInfo);
            // setAuth(adminInfo);
            if (
              adminInfo.admin_level_cd === ROLES.Admin ||
              adminInfo.admin_level_cd === ROLES.Volunteer
            ) {
              // navigate('/ad/dashboard', { replace: true });
            } else {
              // navigate('/user/dashboard', { replace: true });
            }
          }
        } else if (response.data && response.data.resultCode === 404) {
          setLoading(false);
          showToast(
            ToastTypes.ERROR,
            'Ïã§Ìå®',
            'ÏïÑÏù¥Îîî ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûòÎ™ª ÏûÖÎ†•ÌñàÏäµÎãàÎã§. ÏûÖÎ†•ÌïòÏã† ÎÇ¥Ïö©ÏùÑ Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.',
          );
        } else {
          showToast(
            ToastTypes.ERROR,
            'Ïã§Ìå®',
            'ÏïÑÏù¥Îîî ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûòÎ™ª ÏûÖÎ†•ÌñàÏäµÎãàÎã§. ÏûÖÎ†•ÌïòÏã† ÎÇ¥Ïö©ÏùÑ Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.',
          );
        }
      });
    } catch (e) {
      setLoading(false);
      console.log('Error complicated to login => ', e);
      showToast(
        ToastTypes.ERROR,
        'Ïã§Ìå®',
        'ÏïÑÏù¥Îîî(Î°úÍ∑∏Ïù∏ Ï†ÑÏö© ÏïÑÏù¥Îîî) ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûòÎ™ª ÏûÖÎ†•ÌñàÏäµÎãàÎã§. ÏûÖÎ†•ÌïòÏã† ÎÇ¥Ïö©ÏùÑ Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.',
      );
    }
  };

  const handleMouseUp = () => {
    setShowPass(false);
  };

  const handleMouseDown = () => {
    setShowPass(true);
  };

  const handleKeyDown = (e, id) => {
    // console.log("üöÄ ~ handleKeyDown ~ id:", id);
    // console.log("e ==> ", e);
    if (e.keyCode === 13) {
      if (id === 'id') {
        passRef.current.focus();
      } else if (id === 'pass') {
        btnLoginRef.current.focus();
      }
    }
  };

  const handleGoHomeWithoutLogin = () => {
    navigate('/main/map'); // ÌôàÌéòÏù¥ÏßÄ Í≤ΩÎ°úÎ°ú Ïù¥Îèô
  };

  return (
    <>
      <div className="relative h-screen w-screen bg-cover bg-center">
        <div className="flex h-full w-full">
          <img
            src={Background}
            alt="background"
            className="absolute top-0 left-0 w-full h-full object-cover"
          />
          <div className="relative flex h-full w-full">
            <div className="flex-[7]" />
            <div className="flex-[3] flex justify-center items-center bg-white">
              <div className="w-full">
                <div className="w-full justify-center px-6 py-12 ">
                  <div className="sm:mx-auto sm:w-full sm:max-w-sm">
                    {/* TestCourse ManagementSystem */}
                    <h1 className="text-5xl font-bold tracking-tight text-gray-900">
                      TestCourse
                    </h1>
                    <h2 className="text-4xl font-semibold tracking-tight text-blue-700">
                      ManagementSystem
                    </h2>
                  </div>

                  <div className="bg-white px-2 py-12 sm:px-2 mt-10 sm:mx-auto sm:w-full sm:max-w-md">
                    <div className="space-y-6">
                      <div>
                        <div className="flex">
                          <label className="block text-base font-semibold leading-6 text-gray-700">
                            ÏïÑÏù¥Îîî
                          </label>
                          <label className="ml-1 text-base font-semibold leading-6 text-red-500">
                            {' '}
                            *
                          </label>
                        </div>
                        <div className="mt-2">
                          <input
                            className="block w-full rounded-lg border-0 py-3 text-gray-900 shadow ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6 pl-3"
                            placeholder="ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            required
                            ref={idRef}
                            id="userId"
                            name="userId"
                            type="text"
                            autoComplete="off"
                            value={request.admin_id}
                            onKeyDown={(e) => handleKeyDown(e, 'id')}
                            onChange={(e) => {
                              setRequest((preVal) => {
                                return {
                                  ...preVal,
                                  admin_id: e.target.value,
                                };
                              });
                            }}
                          />
                        </div>
                      </div>

                      <div>
                        <div className="flex">
                          <label className="block text-base font-semibold leading-6 text-gray-700">
                            ÎπÑÎ∞ÄÎ≤àÌò∏
                          </label>
                          <label className="ml-1 text-base font-semibold leading-6 text-red-500">
                            {' '}
                            *
                          </label>
                        </div>
                        <div className="relative w-full max-w-md mt-2">
                          <input
                            placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            className="block w-full rounded-lg shadow border-0 py-3 text-gray-900  ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6 pl-3"
                            required
                            ref={passRef}
                            id="password"
                            name="password"
                            type={showPass ? 'text' : 'password'}
                            value={request.password}
                            onKeyDown={(e) => handleKeyDown(e, 'pass')}
                            onChange={(e) => {
                              setRequest((preVal) => {
                                return {
                                  ...preVal,
                                  password: e.target.value,
                                };
                              });
                            }}
                          />
                          <button
                            className="absolute inset-y-0 right-0 flex items-center pr-3"
                            onMouseDown={handleMouseDown}
                            onMouseUp={handleMouseUp}
                            onMouseLeave={handleMouseUp}
                          >
                            {showPass && (
                              <FaRegEye
                                className="-ml-0.5 h-5 w-5 text-gray-400"
                                aria-hidden="true"
                              />
                            )}
                            {!showPass && (
                              <FaRegEyeSlash className="-ml-0.5 h-5 w-5 text-gray-400" />
                            )}
                          </button>
                        </div>
                      </div>

                      {/* FIDO/OTP ÏÑ†ÌÉù Î∞è OTP ÏûÖÎ†• */}
                      <div className="mt-4">
                        <label className="block text-base font-semibold leading-6 text-gray-700">
                          Ïù∏Ï¶ù Î∞©Î≤ï ÏÑ†ÌÉù
                        </label>
                        <div className="flex items-center space-x-4 mt-2">
                          <button
                            className={`px-4 py-2 rounded-lg ${authMethod === 'FIDO' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}
                            onClick={() => setAuthMethod('FIDO')}
                          >
                            FIDO
                          </button>
                          <button
                            className={`px-4 py-2 rounded-lg ${authMethod === 'OTP' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}
                            onClick={() => setAuthMethod('OTP')}
                          >
                            OTP
                          </button>

                          {/* OTP ÏûÖÎ†• ÌïÑÎìú: OTPÍ∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ÏóêÎßå ÎÇòÌÉÄÎÇ® */}
                          {authMethod === 'OTP' && (
                            <input
                              type="text"
                              className="block w-full max-w-xs rounded-lg border-0 py-2 px-3 text-gray-900 shadow ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6"
                              placeholder="OTP Î≤àÌò∏ ÏûÖÎ†•"
                              value={otpCode}
                              onChange={(e) => setOtpCode(e.target.value)}
                            />
                          )}
                        </div>
                      </div>

                      <div>
                        <button
                          ref={btnLoginRef}
                          className="flex w-full justify-center items-center rounded-lg bg-blue-700 px-3 py-4 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-blue-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600"
                          onClick={() => handleSubmit()}
                        >
                          Î°úÍ∑∏Ïù∏
                        </button>
                      </div>

                      {/* Î°úÍ∑∏Ïù∏ ÏóÜÏù¥ Î∞îÎ°ú ÌôàÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô Î≤ÑÌäº */}
                      <div>
                        <button
                          className="flex w-full justify-center items-center rounded-lg bg-gray-400 px-3 py-4 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-gray-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600 mt-4"
                          onClick={handleGoHomeWithoutLogin}
                        >
                          Î©îÏù∏ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                        </button>
                      </div>
                    </div>
                  </div>
                  {/* <div className="flex justify-center mt-10">
                    <p className="text-center text-base font-semibold text-gray-700">
                      ÏïÑÏßÅ Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî?{' '}
                      <Link
                        to={'/register'}
                        className="font-semibold leading-6 text-blue-700 hover:underline hover:text-blue-600 underline underline-offset-4"
                      >
                        ÌöåÏõêÍ∞ÄÏûÖ
                      </Link>
                    </p>
                  </div> */}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  );

  // 2024.10.22 Ïù¥Ï†Ñ Î≤ÑÏ†Ñ Î°úÍ∑∏Ïù∏ ÌôîÎ©¥
  // return (
  //   <div>
  //     {/* Ïª®ÌÖåÏù¥ÎÑà: Î°úÍ∑∏Ïù∏ ÌèºÏùÑ Ï§ëÏïôÏóê Î∞∞ÏπòÌïòÍ≥†, ÌÖåÎëêÎ¶¨ÏôÄ Í∑∏Î¶ºÏûê Ï∂îÍ∞Ä */}
  //     <div className="container m-auto p-auto border-2 border-gray-500 shadow-lg shadow-gray-500 w-1/4 mt-48">
  //       <div className="flex min-h-full flex-1 flex-col justify-center py-6 lg:px-8">
  //         {/* Ï†úÎ™© ÏÑπÏÖò */}
  //         <div className="sm:mx-auto sm:w-full sm:max-w-sm">
  //           <h2 className="text-center text-2xl font-bold tracking-tight text-gray-900">
  //             Test Course <br />
  //             Management System
  //           </h2>
  //         </div>

  //         {/* Î°úÍ∑∏Ïù∏ Ìèº ÏÑπÏÖò */}
  //         <div className="mt-10 sm:mx-auto sm:w-full sm:max-w-sm space-y-6">
  //           {/* Î°úÍ∑∏Ïù∏ Ìèº */}
  //           <form className="space-y-6" action="#" method="POST">
  //             {/* Ïù¥Î©îÏùº ÏûÖÎ†• ÌïÑÎìú */}
  //             <div>
  //               <label
  //                 htmlFor="email"
  //                 className="block text-sm font-medium leading-6 text-gray-900"
  //               >
  //                 Ïù¥Î©îÏùº
  //               </label>
  //               <div className="mt-2">
  //                 <input
  //                   id="email"
  //                   name="email"
  //                   type="email"
  //                   autoComplete="email"
  //                   required
  //                   className="block w-full rounded-md border-0 px-2 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
  //                 />
  //               </div>
  //             </div>

  //             {/* ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• ÌïÑÎìú */}
  //             <div>
  //               <div className="flex items-center justify-between">
  //                 <label
  //                   htmlFor="password"
  //                   className="block text-sm font-medium leading-6 text-gray-900"
  //                 >
  //                   ÎπÑÎ∞ÄÎ≤àÌò∏
  //                 </label>
  //               </div>
  //               <div className="mt-2">
  //                 <input
  //                   id="password"
  //                   name="password"
  //                   type="password"
  //                   autoComplete="current-password"
  //                   required
  //                   className="block w-full rounded-md border-0 px-2 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
  //                 />
  //               </div>
  //             </div>

  //             {/* Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ Ï†ÄÏû• Ï≤¥ÌÅ¨Î∞ïÏä§ */}
  //             <div className="flex items-center justify-between">
  //               <div className="flex items-center">
  //                 <input
  //                   id="remember_me"
  //                   name="remember_me"
  //                   type="checkbox"
  //                   className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
  //                 />
  //                 <label
  //                   htmlFor="remember_me"
  //                   className="block ml-2 text-sm text-gray-900"
  //                 >
  //                   Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ Ï†ÄÏû•
  //                 </label>
  //               </div>
  //             </div>

  //             {/* Î°úÍ∑∏Ïù∏ Î≤ÑÌäº */}
  //             <button
  //               type="submit"
  //               className="w-full flex justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
  //             >
  //               Î°úÍ∑∏Ïù∏
  //             </button>

  //             {/* Î©îÏù∏ÌéòÏù¥ÏßÄÎ°ú Í∞ÄÎäî ÎßÅÌÅ¨ */}
  //             <div>
  //               <Link
  //                 to="/main/map"
  //                 className="flex w-full justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
  //               >
  //                 Î∞îÎ°ú Î©îÏù∏ÌéòÏù¥ÏßÄÎ°ú Í∞ÄÍ∏∞
  //               </Link>
  //             </div>
  //           </form>
  //         </div>
  //       </div>
  //     </div>
  //   </div>
  // );
}
